name: Deploy Production ğŸš€

permissions:
  id-token: write
  contents: read
  issues: write

on:
  workflow_dispatch:

jobs:
  Production:
    runs-on: ubuntu-latest
    environment:
      name: Production
      # url: ${{ steps.deploy.outputs.url }}
    concurrency:
      group: deployment-production
      cancel-in-progress: false
    timeout-minutes: 15
    steps:
      - name: Checkout source ğŸ“¡
        uses: actions/checkout@v4

      - name: Setup Node.js ğŸ“¦
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: "npm"

      - name: Install dependencies ğŸ“¥
        run: npm ci --omit=dev

      - name: Build ğŸ§‘â€ğŸ­
        run: npm run build

      # - name: Configure AWS Credentials ğŸ”‘
      #   uses: aws-actions/configure-aws-credentials@v5.1.1
      #   with:
      #     aws-region: ${{ secrets.AWS_REGION }}
      #     role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}

      # - name: Install infrastructure dependencies ğŸ“¥
      #   run: npm ci
      #   working-directory: infrastructure

      # - name: Deploy to Production ğŸš€
      #   id: deploy
      #   uses: pulumi/actions@v5
      #   with:
      #     command: up
      #     cloud-url: ${{ secrets.PULUMI_BACKEND_URL }}
      #     stack-name: production
      #     work-dir: infrastructure
      #   env:
      #     PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}

      # - name: Invalidate Production CloudFront cache ğŸŒ©ï¸
      #   run: |
      #     aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

      - name: Deploy to Production ğŸš€
        id: deploy
        run: echo "Deployed to Production (skipped for testing)"

      - name: Compute issues to deploy ğŸ“Š
        id: compute
        uses: ./.github/actions/issues-since-deployment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          environment: Production

      - name: Label issues as deployed to production ğŸ·ï¸
        uses: ./.github/actions/label-issues
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          project-number: ${{ vars.PROJECT_NUMBER }}
          issues: ${{ steps.compute.outputs.issues }}
          label: deployed:production

      - name: Track cycle time â±ï¸
        uses: ./.github/actions/track-cycle-time
        with:
          project-token: ${{ secrets.PROJECT_TOKEN }}
          project-number: ${{ vars.PROJECT_NUMBER }}
          issues: ${{ steps.compute.outputs.issues }}
          timezone: Europe/Luxembourg

      - name: Assign iteration ğŸ“…
        uses: ./.github/actions/assign-iteration
        with:
          project-token: ${{ secrets.PROJECT_TOKEN }}
          project-number: ${{ vars.PROJECT_NUMBER }}
          issues: ${{ steps.compute.outputs.issues }}
