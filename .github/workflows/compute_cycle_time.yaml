name: Compute Cycle Time ‚è±Ô∏è

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  ComputeCycleTime:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source üì°
        uses: actions/checkout@v4

      - name: Find issues without cycle time üîç
        id: find
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const projectNumber = parseInt('${{ vars.PROJECT_NUMBER }}');
            const cycleTimeFieldName = 'Cycle Time';

            // Get all project items
            const query = `
              query($owner: String!, $number: Int!, $cycleTimeFieldName: String!) {
                user(login: $owner) {
                  projectV2(number: $number) {
                    items(first: 100) {
                      nodes {
                        content {
                          ... on Issue {
                            number
                            state
                            closedAt
                          }
                        }
                        cycleTime: fieldValueByName(name: $cycleTimeFieldName) {
                          ... on ProjectV2ItemFieldNumberValue {
                            number
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const data = await github.graphql(query, { owner, number: projectNumber, cycleTimeFieldName });
            const items = data.user.projectV2.items.nodes;

            // Filter: closed issues without cycle time, closed in last 7 days
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const issueNumbers = items
              .filter(item => {
                const content = item.content;
                if (!content || !content.number) return false;
                if (content.state !== 'CLOSED') return false;
                if (item.cycleTime?.number !== undefined) return false;
                if (!content.closedAt) return false;
                return new Date(content.closedAt) >= sevenDaysAgo;
              })
              .map(item => item.content.number);

            console.log(`Found ${issueNumbers.length} issues without cycle time: ${issueNumbers.join(', ') || 'none'}`);
            core.setOutput('issues', JSON.stringify(issueNumbers));

      - name: Track cycle time ‚è±Ô∏è
        if: steps.find.outputs.issues != '[]'
        uses: ./.github/actions/track-cycle-time
        with:
          project-token: ${{ secrets.PROJECT_TOKEN }}
          project-number: ${{ vars.PROJECT_NUMBER }}
          issues: ${{ steps.find.outputs.issues }}
          timezone: Europe/Luxembourg
